name: Deploy Frontend to Production

on:
  push:
    branches: [ "linux-production" ]

jobs:
  # Job 1: Verificar TypeScript antes de deploy
  typecheck:
    name: TypeScript Verification
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript check
      run: npx vue-tsc -b

  # Job 2: Deploy solo si typecheck pasa
  deploy:
    name: Deploy Vue.js to Ubuntu Server
    runs-on: ubuntu-latest
    needs: typecheck  # Espera que typecheck pase

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 160
        timeout: 30m
        command_timeout: 30m
        script: |
          # Create parent structure
          mkdir -p ~/aynux

          # Clone/update frontend only
          if [ ! -d ~/aynux/vuejs ]; then
            git clone https://github.com/Excelencia-Digital-Soft/aynux-admin-dashboard.git ~/aynux/vuejs
          fi
          cd ~/aynux/vuejs
          git fetch origin main
          git reset --hard origin/main

          # Check if backend is deployed
          if [ ! -d ~/aynux/python ] || [ ! -f ~/aynux/python/docker-compose.yml ]; then
            echo "ERROR: Backend not deployed yet. Deploy backend first."
            exit 1
          fi

          # Rebuild ONLY frontend container (NO CACHE for fresh build)
          cd ~/aynux/python
          docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache frontend
          docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate --no-deps frontend

          # Cleanup unused images
          docker image prune -f

          # Show new container info
          echo "=== Frontend Container Status ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}" | grep frontend
